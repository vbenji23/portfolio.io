<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Secret ARPG â€“ Portfolio</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:Roboto, sans-serif; text-align:center; }
    #game { display:block; margin:0 auto; }
    .ui { position:fixed; top:12px; left:12px; display:flex; gap:10px; }
    .bar { width:200px; height:14px; background:#333; border:1px solid #888; border-radius:6px; overflow:hidden; }
    .hp { background:#e53935; height:100%; width:100%; transition:width .2s; }
    .stamina { background:#43a047; height:100%; width:100%; transition:width .2s; }
    .bossbar { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); width:50%; height:16px; background:#222; border:1px solid #999; border-radius:8px; overflow:hidden; display:none; }
    .bossfill { background:#8e24aa; height:100%; width:100%; transition:width .2s; }
    .menu { position:fixed; top:10px; right:10px; font-size:14px; }
    a { color:#ffcc00; text-decoration:none; }
  </style>
</head>
<body>
  <div class="ui">
    <div class="bar"><div id="hp" class="hp"></div></div>
    <div class="bar"><div id="stamina" class="stamina"></div></div>
  </div>
  <div class="bossbar"><div id="bossfill" class="bossfill"></div></div>
  <div class="menu"><a href="../index.html">Retour au portfolio</a></div>

  <script>
    const config = {
      type: Phaser.AUTO,
      width: 960,
      height: 540,
      parent: 'game',
      physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
      scene: { preload, create, update }
    };

    let game = new Phaser.Game(config);

    // Game state
    let player, cursors, attackKey, dashKey;
    let enemies, boss, wave = 1, score = 0, bossAlive = false;
    let hp = 100, maxHP = 100;
    let stamina = 100, maxStamina = 100;
    let canAttack = true, comboStep = 0, lastAttackTime = 0;
    let isDashing = false, dashCD = false;
    let hitbox, particles;
    let sfxAttack, sfxDash, sfxHit, sfxEnemyDie, sfxBossIntro;

    function preload() {
      // Remplace ces assets par les tiens (docs/â€¦)
      this.load.image('bg', 'background.png');              // Fond
      this.load.image('player', 'hero.png');                // Sprite hÃ©ros
      this.load.image('enemy', 'enemy.png');                // Sprite ennemi
      this.load.image('boss', 'boss.png');                  // Sprite boss
      this.load.image('spark', 'spark.png');                // Particule impact

      this.load.audio('attack', 'attack.wav');
      this.load.audio('dash', 'dash.wav');
      this.load.audio('hit', 'hit.wav');
      this.load.audio('die', 'die.wav');
      this.load.audio('bossintro', 'bossintro.wav');
    }

    function create() {
      // Background
      this.add.image(config.width/2, config.height/2, 'bg').setAlpha(0.8);

      // Player
      player = this.physics.add.image(480, 300, 'player').setDepth(2);
      player.setCollideWorldBounds(true);
      player.body.setCircle(player.width/2);

      // Controls
      cursors = this.input.keyboard.addKeys({
        up: Phaser.Input.Keyboard.KeyCodes.W,
        down: Phaser.Input.Keyboard.KeyCodes.S,
        left: Phaser.Input.Keyboard.KeyCodes.A,
        right: Phaser.Input.Keyboard.KeyCodes.D
      });
      attackKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
      dashKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT);

      // Groups
      enemies = this.physics.add.group();

      // Hitbox melee (invisible, active seulement pendant les attaques)
      hitbox = this.physics.add.image(player.x, player.y, null).setVisible(false);
      hitbox.body.setAllowGravity(false);
      hitbox.body.setCircle(20);
      hitbox.active = false;

      // Particles
      particles = this.add.particles('spark');

      // SFX
      sfxAttack = this.sound.add('attack', { volume: 0.5 });
      sfxDash = this.sound.add('dash', { volume: 0.5 });
      sfxHit = this.sound.add('hit', { volume: 0.5 });
      sfxEnemyDie = this.sound.add('die', { volume: 0.5 });
      sfxBossIntro = this.sound.add('bossintro', { volume: 0.7 });

      // Collisions: hitbox touche enemies
      this.physics.add.overlap(hitbox, enemies, (hb, enemy) => {
        if (!hb.active || !enemy.active) return;
        enemy.hp -= comboDamage();
        impactFx(this, enemy.x, enemy.y);
        sfxHit.play();
        if (enemy.hp <= 0) {
          enemyDie(enemy);
        }
      });

      // Player contact with enemies (dmg)
      this.physics.add.overlap(player, enemies, (p, enemy) => {
        if (isDashing) return; // invincible durant dash
        takeDamage(8);
      });

      // Waves
      spawnWave(this, wave);

      // Boss bar element
      document.querySelector('.bossbar').style.display = 'none';

      // UI init
      updateBars();
    }

    function update(time, delta) {
      const scene = this;
      // Movement
      const speed = 200;
      let vx = 0, vy = 0;
      if (cursors.left.isDown) vx -= speed;
      if (cursors.right.isDown) vx += speed;
      if (cursors.up.isDown) vy -= speed;
      if (cursors.down.isDown) vy += speed;

      // Normalize diagonal
      if (vx !== 0 && vy !== 0) { vx *= 0.707; vy *= 0.707; }
      player.setVelocity(vx, vy);

      // Attack combos
      if (Phaser.Input.Keyboard.JustDown(attackKey)) {
        tryAttack(scene, time);
      }

      // Dash
      if (Phaser.Input.Keyboard.JustDown(dashKey)) {
        tryDash(scene);
      }

      // Hitbox follow player
      hitbox.setPosition(player.x, player.y);

      // Stamina regen
      if (!isDashing && stamina < maxStamina) {
        stamina = Math.min(maxStamina, stamina + 0.05 * delta);
        updateBars();
      }

      // Enemies AI: move toward player, attack range
      enemies.children.each(enemy => {
        if (!enemy.active) return;
        const dx = player.x - enemy.x;
        const dy = player.y - enemy.y;
        const dist = Math.hypot(dx, dy);
        const ev = enemy.isBoss ? 120 : 100;
        if (dist < 400) {
          enemy.setVelocity((dx/dist) * ev, (dy/dist) * ev);
        } else {
          enemy.setVelocity(0, 0);
        }
        // Boss phase switch
        if (enemy.isBoss && enemy.hp <= enemy.maxHP * 0.5 && !enemy.phase2) {
          enemy.phase2 = true;
          enemy.attackPower += 6;
          enemy.speedBoost = 1.3;
        }
      });

      // Next waves
      if (enemies.countActive() === 0 && !bossAlive) {
        wave++;
        spawnWave(scene, wave);
      }
    }

    // Helpers

    function tryAttack(scene, time) {
      if (!canAttack) return;
      canAttack = false;
      comboStep = (time - lastAttackTime < 450) ? (comboStep + 1) % 3 : 0;
      lastAttackTime = time;

      const reach = 40 + comboStep * 8;
      // Activate hitbox briefly
      hitbox.active = true;
      hitbox.setVisible(false);
      // Offset hitbox in facing direction (estimate by velocity)
      const fx = player.body.velocity.x;
      const fy = player.body.velocity.y;
      const len = Math.hypot(fx, fy) || 1;
      hitbox.setPosition(player.x + (fx/len) * reach, player.y + (fy/len) * reach);

      sfxAttack.play();
      impactFx(scene, hitbox.x, hitbox.y);

      scene.time.delayedCall(120, () => { hitbox.active = false; });
      scene.time.delayedCall(250, () => { canAttack = true; });
    }

    function comboDamage() {
      return [10, 14, 20][comboStep] || 10;
    }

    function tryDash(scene) {
      if (dashCD || isDashing || stamina < 20) return;
      stamina -= 20; updateBars();
      isDashing = true; dashCD = true;
      sfxDash.play();

      // Short invincibility and speed burst
      const dir = new Phaser.Math.Vector2(player.body.velocity.x, player.body.velocity.y);
      if (dir.length() === 0) dir.set(1, 0);
      dir.normalize().scale(400);
      player.setVelocity(dir.x, dir.y);

      scene.time.delayedCall(180, () => { isDashing = false; });
      scene.time.delayedCall(600, () => { dashCD = false; });
    }

    function takeDamage(amount) {
      hp = Math.max(0, hp - amount);
      updateBars();
      flash(player);
      if (hp <= 0) gameOver(false);
    }

    function enemyDie(enemy) {
      sfxEnemyDie.play();
      score += enemy.isBoss ? 100 : 20;
      enemy.disableBody(true, true);
      if (enemy.isBoss) {
        bossAlive = false;
        document.querySelector('.bossbar').style.display = 'none';
        gameOver(true);
      }
    }

    function impactFx(scene, x, y) {
      const emitter = particles.createEmitter({
        x, y,
        speed: { min: 50, max: 150 },
        scale: { start: 0.6, end: 0 },
        lifespan: 300,
        quantity: 8,
        blendMode: 'ADD'
      });
      scene.time.delayedCall(120, () => emitter.remove());
    }

    function flash(sprite) {
      sprite.setTint(0xff0000);
      setTimeout(() => sprite.clearTint(), 100);
    }

    function updateBars() {
      document.getElementById('hp').style.width = `${Math.round(100 * hp / maxHP)}%`;
      document.getElementById('stamina').style.width = `${Math.round(100 * stamina / maxStamina)}%`;
      if (bossAlive && boss) {
        document.getElementById('bossfill').style.width = `${Math.round(100 * boss.hp / boss.maxHP)}%`;
      }
    }

    function spawnWave(scene, w) {
      // Every 3 waves, spawn boss
      if (w % 3 === 0) {
        spawnBoss(scene);
        return;
      }
      const count = Math.min(6 + w * 2, 16);
      for (let i = 0; i < count; i++) {
        const ex = Phaser.Math.Between(80, config.width - 80);
        const ey = Phaser.Math.Between(80, config.height - 80);
        const e = enemies.create(ex, ey, 'enemy');
        e.hp = 30 + w * 6;
        e.maxHP = e.hp;
        e.attackPower = 6 + w;
        e.isBoss = false;
      }
    }

    function spawnBoss(scene) {
      const ex = config.width / 2;
      const ey = 120;
      boss = enemies.create(ex, ey, 'boss');
      boss.setScale(1.2);
      boss.hp = 300;
      boss.maxHP = 300;
      boss.attackPower = 12;
      boss.isBoss = true;
      boss.phase2 = false;
      bossAlive = true;
      sfxBossIntro.play();
      document.querySelector('.bossbar').style.display = 'block';
      updateBars();
    }

    function gameOver(win) {
      const msg = win ? "ðŸŽ‰ Tu as vaincu le boss et dÃ©bloquÃ© le vrai secret !" :
                        "â˜ ï¸ Tu es mort... essaie encore !";
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.left = 0; overlay.style.top = 0;
      overlay.style.width = '100%'; overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.6)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.color = '#fff';
      overlay.style.fontSize = '24px';
      overlay.style.zIndex = 10;
      overlay.innerHTML = `<div style="text-align:center;">
        <p>${msg}</p>
        <p><a href="../index.html">Retour au portfolio</a></p>
      </div>`;
      document.body.appendChild(overlay);
      game.scene.pause();
    }
  </script>
</body>
</html>
